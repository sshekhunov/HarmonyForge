<div *ngIf="loading" class="loading-container">
  <div class="loading-content">
    <p-progressSpinner
      [style]="{'width': '50px', 'height': '50px'}"
      strokeWidth="4"
      fill="transparent"
      animationDuration="1s">
    </p-progressSpinner>
    <p class="loading-text">Загрузка статей...</p>
  </div>
</div>

<div *ngIf="error && !loading" class="error-container">
  <div class="error-content">
    <i class="pi pi-exclamation-triangle error-icon"></i>
    <h3>Что-то пошло не так</h3>
    <p>{{ error }}</p>
    <p-button
      label="Попробовать снова"
      icon="pi pi-refresh"
      (onClick)="onRetryLoad()"
      [outlined]="true">
    </p-button>
  </div>
</div>

<div *ngIf="!loading && !error && course" class="course-detail-container">
  <div class="course-header">
    <div class="course-header-content">
      <a class="back-link" (click)="onGoBack()">
        <i class="pi pi-arrow-left"></i> Назад к курсам
      </a>
      <div class="course-title-section">
        <h1 class="course-title">{{ course.title }}</h1>
        <h2 class="course-subtitle" *ngIf="course.description">{{ course.description }}</h2>
      </div>
    </div>
  </div>
  <div class="modules-sidebar">
    <div *ngFor="let module of course.modules; trackBy: trackByModuleId"
         class="module-item"
         [class.active]="isModuleSelected(module.id)"
         (click)="onModuleSelected(module.id)">
      <div class="module-progress-circle">
        <svg class="progress-svg" viewBox="0 0 28 28">
          <circle class="progress-ring-bg" cx="14" cy="14" r="12" fill="none" stroke="#e0e0e0" stroke-width="2"></circle>
          <circle class="progress-ring"
                  cx="14"
                  cy="14"
                  r="12"
                  fill="none"
                  stroke="#4caf50"
                  stroke-width="2"
                  [attr.stroke-dasharray]="getProgressDashArray(module.id)"
                  [attr.stroke-dashoffset]="getProgressDashOffset(module.id)"
                  transform="rotate(-90 14 14)"></circle>
        </svg>
        <div class="progress-fill" *ngIf="isModuleSelected(module.id)"></div>
      </div>
      <div class="module-info">
        <h3 class="module-title">{{ module.title }}</h3>
        <p class="module-description" *ngIf="module.description">
          {{ module.description }}
        </p>
      </div>
    </div>
  </div>

  <div class="course-content">
    <div class="learning-items-content">
      <div *ngIf="getSelectedModule()" class="selected-module-content">
        <div class="module-header">
          <h2 class="module-content-title">{{ getSelectedModule()?.title }}</h2>
          <p class="module-content-description" *ngIf="getSelectedModule()?.description">
            {{ getSelectedModule()?.description }}
          </p>
        </div>

        <div class="learning-items-list">
          <div *ngFor="let itemWithModule of getSelectedModuleItems(); trackBy: trackByItemId"
               class="learning-item"
               [class.exercise-item]="itemWithModule.item.itemType === 1">
            <div class="learning-item-main-content"
                 [class.exercise-content]="itemWithModule.item.itemType === 1"
                 (click)="itemWithModule.item.itemType === 0 ? onItemSelected(itemWithModule.item, getSelectedModule()!) : null">
              <div class="learning-item-icon">
                <i [class]="itemWithModule.item.itemType === 0 ? 'pi pi-book' : 'pi pi-pencil'"></i>
              </div>
              <div class="learning-item-content">
                <h4 class="learning-item-title">{{ getItemTitle(itemWithModule.item) }}</h4>
                <p class="learning-item-description" *ngIf="getItemDescription(itemWithModule.item)">
                  {{ getItemDescription(itemWithModule.item) }}
                </p>
              </div>
            </div>
            <div *ngIf="isAuthenticated"
                 [class]="itemWithModule.item.itemType === 0 ? 'learning-item-checkbox' : 'exercise-checkbox-container'"
                 (click)="$event.stopPropagation()">
              <span *ngIf="itemWithModule.item.itemType === 1" class="exercise-score">{{ getItemScore(itemWithModule.item.id) }}%</span>
              <p-checkbox
                [binary]="true"
                [ngModel]="isItemCompleted(itemWithModule.item.id)"
                [readonly]="itemWithModule.item.itemType === 1"
                (ngModelChange)="itemWithModule.item.itemType === 0 ? onArticleCompletionChange(itemWithModule.item.id, $event) : null"
                [inputId]="'checkbox-' + itemWithModule.item.id">
              </p-checkbox>
            </div>
          </div>

          <div *ngIf="getSelectedModuleItems().length === 0" class="no-learning-items">
            <i class="pi pi-file-o no-learning-items-icon"></i>
            <p>Статьи и упражнения для этого модуля пока недоступны.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
